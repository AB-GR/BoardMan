@using BoardMan.Web.Infrastructure.Extensions
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model Board
@{
    ViewData["Title"] = "View Board";
}

<h1>@ViewData["Title"]</h1>

<h3>@Model.Title</h3>
<p>@Model.Description</p>
<h3>Lists & Tasks</h3>

<div id="listsTable"></div>

@section Css
{
	<link href="@Url.Content("~/lib/jquery-ui-1.13.1/jquery-ui.css")" rel="stylesheet" type="text/css" />
	<link href="@Url.Content("~/lib/jtable.2.4.0/themes/metro/blue/jtable.css")" rel="stylesheet" type="text/css" />
}

@section scripts
{
    <script src="~/lib/jquery-ui-1.13.1/jquery-ui.js"></script>
    <script src="~/lib/jtable.2.4.0/jquery.jtable.js"></script> 

    <script type="text/javascript">
        $(function () {
        $('#listsTable').jtable({
                title: "Lists",
                sorting: false,
				multiSorting: false,
				columnSelectable: false,				
				AntiForgeryToken: '@Html.AntiForgeryTokenValue()',
				actions: {
					listAction: '/Lists/GetListsByBoardId?boardId=@Model.Id',
                    createAction: '/Lists/CreateList',
                    updateAction: '/Lists/UpdateList',
                    deleteAction: '/Lists/DeleteList'
				},
				fields: {
                    BoardId: {
                        type: 'hidden',
                        defaultValue: '@Model.Id'
                    },
                    Id: {
                        key: true,
                        create: false,
                        edit: false,
                        list: false
                    },
					Title: {
						title: 'Title'
					},
					Description: {
						title: 'Description'
					},
                    Tasks: {
                        tableId: 'tasksTable',
                        title: 'Tasks',
                        width: '5%',
                        sorting: false,
                        edit: false,
                        create: false,
                        display: function (listData) {
                            var $img = $('<img src="/lib/jtable.2.4.0/themes/basic/close.png" title="Manage Tasks" />');
                            $img.click(function () {
                                $('#listsTable').jtable('openChildTable', $img.closest('tr'), {
                                    title: "Tasks",
                                    sorting: false,
				                    multiSorting: false,
				                    columnSelectable: false,				
				                    AntiForgeryToken: '@Html.AntiForgeryTokenValue()',
				                    actions: {
					                    listAction: '/Tasks/GetTasksByListId?listId=' + listData.record.Id,
                                        createAction: '/Tasks/CreateTask',
                                        updateAction: '/Tasks/UpdateTask',
                                        deleteAction: '/Tasks/DeleteTask'
				                    },
                                    fields: {
                                        ListId: {
                                            title: 'List',
                                            list: false,
                                            options: '/Boards/ListOtherLists?boardId=@Model.Id&listId=' + listData.record.Id
                                        },
                                        Id: {
                                            key: true,
                                            create: false,
                                            edit: false,
                                            list: false
                                        },
					                    Title: {
						                    title: 'Title'
					                    },
					                    Description: {
						                    title: 'Description'
					                    },
                                        EndDate: {
                                            title: 'End Date',                                            
                                        },
                                        ActualEndDate: {
                                            title: 'Actual End Date'
                                        },
                                        IsCompleted: {
                                            title: 'Is Completed',
                                            display: function (data) {
                                                return `<input type="checkbox" id="isCompleted" name="isCompleted" ${data.record.IsCompleted === true ? 'checked' : ''}>`;
                                            }
                                        },
                                        AssignedToId:{
                                            title: "Assigned To",
                                            options: '/Boards/ListBoardMembers?boardId=@Model.Id'
                                        },
                                        Comments:
                                        {                                            
                                            title: 'Comments',
                                            width: '5%',
                                            sorting: false,
                                            edit: false,
                                            create: false,
                                            display: function (tasksData) {
                                                console.log(tasksData);
                                                var $img = $('<img src="/lib/jtable.2.4.0/themes/basic/close.png" title="Manage Comments" />');
                                                $img.click(function () {
                                                    $img.closest('.jtable-child-table-container').jtable('openChildTable', $img.closest('tr'), {
                                                        title: "Comments",
                                                        sorting: false,
				                                        multiSorting: false,
				                                        columnSelectable: false,				
				                                        AntiForgeryToken: '@Html.AntiForgeryTokenValue()',
				                                        actions: {
					                                        listAction: '/Tasks/GetTaskComments?taskId=' + tasksData.record.Id,
                                                            createAction: '/Tasks/CreateTaskComment',
                                                            updateAction: '/Tasks/UpdateTaskComment',
                                                            deleteAction: '/Tasks/DeleteTaskComment'
				                                        },
                                                        fields: {
                                                            TaskId: {
                                                                type: 'hidden',
                                                                defaultValue: tasksData.record.Id
                                                            },
                                                            Id: {
                                                                key: true,
                                                                create: false,
                                                                edit: false,
                                                                list: false
                                                            },
					                                        Comment: {
						                                        title: 'Comment'
					                                        },
                                                            CommentedByName:{
                                                                title: "Commented By",
                                                                create: false,
                                                                edit: false
                                                            },
                                                            CommentedById: {
                                                                type: 'hidden'
                                                            }
                                                        }
                                                    }, function (data) { //opened handler
                                                        data.childTable.jtable('load');
                                                    });
                                                });
                            
                                                return $img;
                                            }
                                        },
                                        Labels:
                                        {                                            
                                            title: 'Labels',
                                            width: '5%',
                                            sorting: false,
                                            edit: false,
                                            create: false,
                                            display: function (labelData) {                                                
                                                var $img = $('<img src="/lib/jtable.2.4.0/themes/basic/close.png" title="Manage Labels" />');
                                                $img.click(function () {
                                                    $img.closest('.jtable-child-table-container').jtable('openChildTable', $img.closest('tr'), {
                                                        title: "Labels",
                                                        sorting: false,
				                                        multiSorting: false,
				                                        columnSelectable: false,				
				                                        AntiForgeryToken: '@Html.AntiForgeryTokenValue()',
				                                        actions: {
					                                        listAction: '/Tasks/GetTaskLabels?taskId=' + labelData.record.Id,
                                                            createAction: '/Tasks/CreateTaskLabel',
                                                            updateAction: '/Tasks/UpdateTaskLabel',
                                                            deleteAction: '/Tasks/DeleteTaskLabel'
				                                        },
                                                        fields: {
                                                            TaskId: {
                                                                type: 'hidden',
                                                                defaultValue: labelData.record.Id
                                                            },
                                                            Id: {
                                                                key: true,
                                                                create: false,
                                                                edit: false,
                                                                list: false
                                                            },
					                                        Label: {
						                                        title: 'Label'
					                                        }
                                                        }
                                                    }, function (data) { //opened handler
                                                        data.childTable.jtable('load');
                                                    });
                                                });
                            
                                                return $img;
                                            }
                                        }
                                    }
                                }, function (data) { //opened handler
                                    data.childTable.jtable('load');
                                });
                            });
                            
                            return $img;
                        }
                    }
				}				
            }).jtable('load');
        });
    </script>
}